# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å­¦ç¿’ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®ãŠã™ã™ã‚ã®å­¦ç¿’é †åºã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

---

## å­¦ç¿’ã®å…¨ä½“åƒ

```
[1. å‹å®šç¾©] â†’ [2. ã‚¨ãƒ©ãƒ¼å‡¦ç†] â†’ [3. APIãƒ˜ãƒ«ãƒ‘ãƒ¼] â†’ [4. ã‚µãƒ¼ãƒ“ã‚¹å±¤] â†’ [5. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼] â†’ [6. ãƒ«ãƒ¼ã‚¿ãƒ¼] â†’ [7. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ]
```

**ãƒã‚¤ãƒ³ãƒˆ**: ä¸‹å±¤ï¼ˆå‹å®šç¾©ï¼‰ã‹ã‚‰ä¸Šå±¤ï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰ã¸å‘ã‹ã£ã¦å­¦ã¶ã¨ã€ä¾å­˜é–¢ä¿‚ãŒç†è§£ã—ã‚„ã™ã„

---

## Step 1: å‹å®šç¾©ã‚’ç†è§£ã™ã‚‹

ğŸ“ `backend/src/types/index.ts`

**å­¦ã¶ã“ã¨**:
- ã‚¢ãƒ—ãƒªã§æ‰±ã†ãƒ‡ãƒ¼ã‚¿ã®å½¢ï¼ˆUser, Task, Habitç­‰ï¼‰
- TypeScriptã®å‹å®šç¾©ï¼ˆinterface, typeï¼‰
- å®šæ•°ã®å®šç¾©ï¼ˆPOINT_RANGES, BADGE_DEFINITIONSç­‰ï¼‰

**é‡è¦ãªå‹**:
```typescript
// é›£æ˜“åº¦ã®å‹ï¼ˆãƒªãƒ†ãƒ©ãƒ«å‹ï¼‰
type Difficulty = 'easy' | 'medium' | 'hard';

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‹ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰
interface User {
  id: string;
  email: string;
  // ...
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é™¤å¤–ã—ãŸå‹ï¼ˆOmitãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å‹ï¼‰
type UserWithoutPassword = Omit<User, 'passwordHash'>;
```

**ç†è§£åº¦ãƒã‚§ãƒƒã‚¯**:
- [ ] `interface` ã¨ `type` ã®é•ã„ãŒã‚ã‹ã‚‹
- [ ] `Omit<T, K>` ã®æ„å‘³ãŒã‚ã‹ã‚‹
- [ ] ãªãœ `Difficulty` ã‚’æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«å‹ã«ã™ã‚‹ã®ã‹ã‚ã‹ã‚‹

---

## Step 2: ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ç†è§£ã™ã‚‹

ğŸ“ `backend/src/errors/`

**èª­ã‚€é †ç•ª**:
1. `AppError.ts` - åŸºåº•ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
2. `BusinessError.ts` - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ç”¨ã‚¨ãƒ©ãƒ¼
3. `errorHandler.ts` - ExpressãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
4. `index.ts` - ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

**å­¦ã¶ã“ã¨**:
- ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿ï¼ˆextendsï¼‰
- HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ã‚¨ãƒ©ãƒ¼ã®å¯¾å¿œ
- Expressã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

**é‡è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³**:
```typescript
// åŸºåº•ã‚¯ãƒ©ã‚¹
class AppError extends Error {
  constructor(message: string, code: string, statusCode: number) {
    super(message);
    this.code = code;
    this.statusCode = statusCode;
  }
}

// ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹
class NotFoundError extends AppError {
  constructor(message: string) {
    super(message, 'NOT_FOUND', 404);
  }
}
```

**ç†è§£åº¦ãƒã‚§ãƒƒã‚¯**:
- [ ] `extends` ã§ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã§ãã‚‹
- [ ] `super()` ã§è¦ªã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã¹ã‚‹
- [ ] Expressã®ã‚¨ãƒ©ãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å¼•æ•°ãŒ4ã¤ãªç†ç”±ãŒã‚ã‹ã‚‹

---

## Step 3: APIãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ç†è§£ã™ã‚‹

ğŸ“ `backend/src/api/`

**èª­ã‚€é †ç•ª**:
1. `response.ts` - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒ«ãƒ‘ãƒ¼
2. `validation.ts` - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
3. `index.ts` - ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

**å­¦ã¶ã“ã¨**:
- ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ï¼ˆ`<T>`ï¼‰
- ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ï¼ˆBuilder ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
- Expressã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é–¢æ•°

**é‡è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³**:
```typescript
// ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚’ä½¿ã£ãŸæ±ç”¨é–¢æ•°
function sendSuccess<T>(res: Response, data: T): void {
  res.json({ data });
}

// ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³
v.string().required().min(1).max(100)
```

**ç†è§£åº¦ãƒã‚§ãƒƒã‚¯**:
- [ ] `<T>` ãŒãªãœå¿…è¦ã‹ã‚ã‹ã‚‹
- [ ] ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã§ `this` ã‚’è¿”ã™ç†ç”±ãŒã‚ã‹ã‚‹
- [ ] ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é–¢æ•°ã® `(req, res, next)` ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‹ã‚‹

---

## Step 4: ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚’ç†è§£ã™ã‚‹ï¼ˆæœ€é‡è¦ï¼‰

ğŸ“ `backend/src/services/`

**èª­ã‚€é †ç•ª**:
1. `UserService.ts` - åŸºæœ¬çš„ãªCRUDã¨ãƒã‚¤ãƒ³ãƒˆç®¡ç†
2. `CategoryService.ts` - ã‚·ãƒ³ãƒ—ãƒ«ãªCRUD
3. `TaskService.ts` - ä»–ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æº
4. `RewardService.ts` - ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»å‡¦ç†
5. `HabitService.ts` - Streakè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
6. `BadgeService.ts` - æ¡ä»¶åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
7. `PomodoroService.ts` - çµ±è¨ˆè¨ˆç®—
8. `StatsService.ts` - è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ã®é›†ç´„
9. `index.ts` - åˆæœŸåŒ–å‡¦ç†

**å­¦ã¶ã“ã¨**:
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
- ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚
- éåŒæœŸå‡¦ç†ï¼ˆasync/awaitï¼‰
- Map ã‚’ä½¿ã£ãŸä»®ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢

**é‡è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³**:
```typescript
// ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹
class TaskService {
  private tasks: Map<string, Task> = new Map();

  async create(userId: string, data: CreateTaskData): Promise<Task> {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    // ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    // ä¿å­˜
    return task;
  }
}

// ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
export const taskService = new TaskService();
```

**ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚**:
```
TaskService â”€â”€â†’ UserServiceï¼ˆãƒã‚¤ãƒ³ãƒˆä»˜ä¸ï¼‰
            â””â”€â†’ BadgeServiceï¼ˆãƒãƒƒã‚¸åˆ¤å®šï¼‰

RewardService â”€â”€â†’ UserServiceï¼ˆãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»ï¼‰

HabitService â”€â”€â†’ UserServiceï¼ˆXPä»˜ä¸ï¼‰
             â””â”€â†’ BadgeServiceï¼ˆãƒãƒƒã‚¸åˆ¤å®šï¼‰
```

**ç†è§£åº¦ãƒã‚§ãƒƒã‚¯**:
- [ ] `async/await` ã®ä½¿ã„æ–¹ãŒã‚ã‹ã‚‹
- [ ] `Map` ã®ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆget, set, delete, valuesï¼‰ãŒã‚ã‹ã‚‹
- [ ] ãªãœã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã«ã™ã‚‹ã®ã‹ã‚ã‹ã‚‹
- [ ] ã‚µãƒ¼ãƒ“ã‚¹é–“ã§ä¾å­˜é–¢ä¿‚ãŒç”Ÿã¾ã‚Œã‚‹ç†ç”±ãŒã‚ã‹ã‚‹

---

## Step 5: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ç†è§£ã™ã‚‹

ğŸ“ `backend/src/controllers/`

**èª­ã‚€é †ç•ª**:
1. `TaskController.ts` - å…¸å‹çš„ãªCRUDã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
2. `AuthController.ts` - èªè¨¼ç³»
3. ä»–ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
4. `index.ts` - ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

**å­¦ã¶ã“ã¨**:
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆreq.body, req.params, req.queryï¼‰
- ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
- asyncHandler ã§ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ

**é‡è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³**:
```typescript
class TaskController {
  // ã‚¢ãƒ­ãƒ¼é–¢æ•°ã§ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ï¼ˆthisã®ãƒã‚¤ãƒ³ãƒ‰å•é¡Œã‚’å›é¿ï¼‰
  list = asyncHandler(async (req: Request, res: Response) => {
    const userId = (req as any).userId;
    const { page, limit } = parsePagination(req.query);

    const result = await taskService.list(userId, filter);

    sendPaginated(res, result.tasks, result.total, page, limit);
  });
}
```

**ç†è§£åº¦ãƒã‚§ãƒƒã‚¯**:
- [ ] `req.body`, `req.params`, `req.query` ã®é•ã„ãŒã‚ã‹ã‚‹
- [ ] ã‚¢ãƒ­ãƒ¼é–¢æ•°ã§ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã™ã‚‹ç†ç”±ãŒã‚ã‹ã‚‹
- [ ] ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ã‚µãƒ¼ãƒ“ã‚¹ã®å½¹å‰²åˆ†æ‹…ãŒã‚ã‹ã‚‹

---

## Step 6: ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ç†è§£ã™ã‚‹

ğŸ“ `backend/src/routes/`

**èª­ã‚€é †ç•ª**:
1. `tasks.ts` - å…¸å‹çš„ãªRESTfulãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
2. ä»–ã®ãƒ«ãƒ¼ã‚¿ãƒ¼
3. `index.ts` - ãƒ«ãƒ¼ãƒˆã®é›†ç´„

**å­¦ã¶ã“ã¨**:
- Express Router
- RESTfulãªURLè¨­è¨ˆ
- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®é©ç”¨

**é‡è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³**:
```typescript
const router = Router();

// GET /api/tasks
router.get('/', taskController.list);

// POST /api/tasksï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
router.post('/', validateBody({...}), taskController.create);

// GET /api/tasks/:idï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãï¼‰
router.get('/:id', taskController.get);

// POST /api/tasks/:id/completeï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
router.post('/:id/complete', taskController.complete);
```

**ç†è§£åº¦ãƒã‚§ãƒƒã‚¯**:
- [ ] HTTPãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆGET, POST, PATCH, DELETEï¼‰ã®ä½¿ã„åˆ†ã‘ãŒã‚ã‹ã‚‹
- [ ] `:id` ãŒãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãªã‚‹ä»•çµ„ã¿ãŒã‚ã‹ã‚‹
- [ ] ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒå·¦ã‹ã‚‰å³ã«å®Ÿè¡Œã•ã‚Œã‚‹é †åºãŒã‚ã‹ã‚‹

---

## Step 7: ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’ç†è§£ã™ã‚‹

ğŸ“ `backend/src/index.ts`

**å­¦ã¶ã“ã¨**:
- Expressã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ„ã¿ç«‹ã¦
- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®é©ç”¨é †åº
- ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•

**é‡è¦ãªé †åº**:
```typescript
// 1. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†å‰ï¼‰
app.use(cors());
app.use(express.json());

// 2. ãƒ«ãƒ¼ãƒˆ
app.use('/api', routes);

// 3. 404ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆï¼‰
app.use(notFoundHandler);

// 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆæœ€å¾Œã«é…ç½®ï¼‰
app.use(errorHandler);
```

**ç†è§£åº¦ãƒã‚§ãƒƒã‚¯**:
- [ ] ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®é©ç”¨é †åºãŒé‡è¦ãªç†ç”±ãŒã‚ã‹ã‚‹
- [ ] ãªãœã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’æœ€å¾Œã«ç½®ãã®ã‹ã‚ã‹ã‚‹

---

## å®Ÿè·µèª²é¡Œ

### èª²é¡Œ1: ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
1. `POST /api/tasks` ã§ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã™ã‚‹æµã‚Œã‚’è¿½ã£ã¦ã¿ã‚ˆã†
   - `routes/tasks.ts` â†’ `controllers/TaskController.ts` â†’ `services/TaskService.ts`

### èª²é¡Œ2: ãƒ‡ãƒãƒƒã‚°
1. å„ã‚µãƒ¼ãƒ“ã‚¹ã« `console.log` ã‚’è¿½åŠ ã—ã¦ã€å‡¦ç†ã®æµã‚Œã‚’ç¢ºèªã—ã¦ã¿ã‚ˆã†

### èª²é¡Œ3: æ©Ÿèƒ½è¿½åŠ 
1. `TaskService` ã«ã€ŒæœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ã¿ã‚ˆã†

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [TypeScriptå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.typescriptlang.org/docs/)
- [Expresså…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://expressjs.com/)
- [MDN - async/await](https://developer.mozilla.org/ja/docs/Learn/JavaScript/Asynchronous/Promises)

---

## å›°ã£ãŸã¨ãã¯

1. **å‹ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹** â†’ `types/index.ts` ã‚’ç¢ºèª
2. **ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼ãŒã‚ã‹ã‚‰ãªã„** â†’ `errors/errorHandler.ts` ã‚’ç¢ºèª
3. **ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ãˆã°ã„ã„ã‹ã‚ã‹ã‚‰ãªã„** â†’ `services/index.ts` ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ç¢ºèª
4. **APIã®URLãŒã‚ã‹ã‚‰ãªã„** â†’ `routes/index.ts` ã‚’ç¢ºèª
